<!DOCTYPE html>
<html>

<head>
    <title>Transactions</title>
</head>

<body>

    <h2><a href='/customers/'>Customers</a> <a href='/items/'>Items</a></h2>
    <h2>Items</h2>
        <div>
            <h3>{{ message }}</h3>
        </div>

        <strong>{{customer[0][1]}}</strong>

        <form id="transaction_form" method="POST" action="/transaction/{{customer[0][0]}}/">
        Unit Price Per Gram :<input type="text" id="unit_price" name="unit_price" value="{{todays_gold_price}}" >
        <Strong>Tax %</Strong><input id="tax" name="tax" value="20" > 
        <Strong>Misc Charges</Strong><input id="misc" name="misc" value="0.00" >
        <Strong>Total</Strong><input type="number" id="grand_total" name="grand_total" value="0.00" readonly>
        <!-- <button type="button" onclick="calculateGrandTotal()">Calculate Final Total</button> -->
        <button type = "button" onclick="reset()">Reset</button>
        <input type="Submit" onclick="calculateGrandTotal();" value="Save" ><br><br>
        <div>

        <table id="data_table" style="width:1000px" border="3">
            <th>ID</th>
            <th>Name</th>
            <th>Description</th>
            <th>Weight (Gms)</th>
            <th>Photo</th>
            <th>Stock</th>
            <th>Qty</th>
            <th>Price</th>
            <th>Discount (%)</th>
            <th>Price after discount</th>
            {% for c in items %}
            <tr>
                <td>{{c[0]}}</td>
                <td>{{c[1]}}</td>
                <td>{{c[2]}}</td>
                <td><input id="weight{{c[0]}}" name="weight{{c[0]}}" value="{{c[3]}}" disabled></td>
                <td><img src='{{c[4]}}'></td>
                <td>{{c[6]}}</td>
                <td><input id="qty{{c[0]}}" name="qty{{c[0]}}" type="number" min="0" max="{{c[6]}}" value="0" onchange="calculatePrice()" onkeydown="return false" ></td>
                <td><input id="price{{c[0]}}" name="price{{c[0]}}" value="0.00" disabled></td>
                <td><input id="discount{{c[0]}}" name="discount{{c[0]}}" type="number"  value="0.00" min="0"  onchange="calculateDiscountedPrice()" onkeydown="return false" ></td>
                <td><input id="total_price{{c[0]}}" name="total_price{{c[0]}}" value="0.00" ></td>
            </tr>
            {% endfor %}
        </table><br><br>
    </form>
            <script>
                function reset(){
                    for (i=0;i<inputs.length;i++){
                        if (inputs[i].name.startsWith('qty')){
                            itemid = inputs[i].name.substring(3)
                            document.getElementById('qty'+itemid).value = 0.00
                            document.getElementById('price'+itemid).value = 0.00
                            document.getElementById('discount'+itemid).value = 0.00
                            document.getElementById('total_price'+itemid).value = 0.00
                        }
                    }
                    document.getElementById('grand_total').value = 0.00
                    document.getElementById('tax').value = 20.00
                    document.getElementById('misc').value = 0.00
                    return false;
                };

                function calculatePrice(){
                    unit_price=document.getElementById('unit_price').value
                    inputs=document.getElementsByTagName('input')
                    for (i=0;i<inputs.length;i++){
                        if (inputs[i].name.startsWith('qty')){
                            itemid = inputs[i].name.substring(3)
                            document.getElementById('price'+itemid).value = 
                                Math.ceil(document.getElementById('weight'+itemid).value
                                * unit_price * document.getElementById('qty'+itemid).value)
                            document.getElementById('total_price'+itemid).value = 
                                Math.ceil(document.getElementById('price'+itemid).value)
                        }
                    }
                    calculateGrandTotal();
                    return false;
                };

                function calculateDiscountedPrice(){
                    inputs=document.getElementsByTagName('input')
                    grand_total = 0
                    for (i=0;i<inputs.length;i++){
                        if (inputs[i].name.startsWith('qty')){
                            itemid = inputs[i].name.substring(3)
                            document.getElementById('total_price'+itemid).value = 
                                Math.ceil(document.getElementById('price'+itemid).value * 
                                    (1-document.getElementById('discount'+itemid).value/100))

                        }
                    }
                    calculateGrandTotal();
                    return false;
                };
                function calculateGrandTotal(){
                    inputs=document.getElementsByTagName('input')
                    grand_total = 0.00
                    for (i=0;i<inputs.length;i++){
                        if (inputs[i].name.startsWith('total_price')){
                            itemid = inputs[i].name.substring("total_price".length)
                            grand_total += parseInt(document.getElementById('total_price'+itemid).value)

                        }
                    }
                    tax = document.getElementById('tax').value/100
                    grand_total += grand_total * tax
                    grand_total -= document.getElementById('misc').value
                    document.getElementById('grand_total').value = Math.ceil(grand_total)
                    return false; 
                };
        </script>
    </div>
</body>

</html>